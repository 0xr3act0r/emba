#!/bin/bash

EMBA_CONFIG_PATH="./config"

## Color definition
GREEN="\033[0;32m"
ORANGE="\033[0;33m"
NC="\033[0m"  # no color

if ! [[ -d "$EMBA_CONFIG_PATH" ]]; then
  echo "[-] No EMBA config directory found! Please start this crawler from the EMBA directory"
  exit 1
fi

if [[ -f "$EMBA_CONFIG_PATH"/known_exploited_vulnerabilities.csv ]]; then
  echo -e "${GREEN}[+] Known exploit database has $ORANGE$(wc -l "$EMBA_CONFIG_PATH"/known_exploited_vulnerabilities.csv | awk '{print $1}')$GREEN exploit entries (before update).$NC"
fi

echo "[*] Update the known_exploited_vulnerabilities database"
wget https://www.cisa.gov/sites/default/files/csv/known_exploited_vulnerabilities.csv -O "$EMBA_CONFIG_PATH"/known_exploited_vulnerabilities_new.csv || true

if [[ $(wc -l "$EMBA_CONFIG_PATH"/known_exploited_vulnerabilities_new.csv | awk '{print $1}') -ge $(wc -l "$EMBA_CONFIG_PATH"/known_exploited_vulnerabilities.csv | awk '{print $1}') ]]; then
  # copy it only if the updated file is bigger then the installed one
  mv "$EMBA_CONFIG_PATH"/known_exploited_vulnerabilities_new.csv "$EMBA_CONFIG_PATH"/known_exploited_vulnerabilities.csv
fi

if [[ -f "$EMBA_CONFIG_PATH"/known_exploited_vulnerabilities_new.csv ]]; then
  rm "$EMBA_CONFIG_PATH"/known_exploited_vulnerabilities_new.csv
fi

if [[ -f "$EMBA_CONFIG_PATH"/known_exploited_vulnerabilities.csv ]]; then
  echo -e "${GREEN}[+] Known exploit database now has $ORANGE$(wc -l "$EMBA_CONFIG_PATH"/known_exploited_vulnerabilities.csv | awk '{print $1}')$GREEN exploit entries (after update).$NC"
fi
