name: EMBA Docker Image build

  #on:
  #schedule:
  #  - cron: '0 0 * * *' # do it every day

on:
  push:
    branches:
      - '**'        # matches every branch
  pull_request:
    branches:
      - '**'
      # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:

jobs:
  docker-build:
    if: github.repository_owner == 'e-m-b-a'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v3
      - name: Free Disk Space (Ubuntu)
        uses: jlumbroso/free-disk-space@main
        with:
          tool-cache: true
          android: true
          dotnet: true
          haskell: true
          large-packages: false
          swap-storage: true
      - name: EMBA container build
        uses: nick-fields/retry@v2
        with:
          timeout_minutes: 600
          max_attempts: 3
          command: docker image prune && docker container prune && \
            apt-get -y install python3-venv && \
            create_pipenv "./external/emba_venv" && \
            activate_pipenv "./external/emba_venv" &&\ 
            docker-compose build --no-cache --pull && ./emba -d 2 -y -j
