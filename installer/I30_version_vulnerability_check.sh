#!/bin/bash

# EMBA - EMBEDDED LINUX ANALYZER
#
# Copyright 2020-2022 Siemens AG
# Copyright 2020-2022 Siemens Energy AG
#
# EMBA comes with ABSOLUTELY NO WARRANTY. This is free software, and you are
# welcome to redistribute it under the terms of the GNU General Public License.
# See LICENSE file for usage of this software.
#
# EMBA is licensed under GPLv3
#
# Author(s): Michael Messner, Pascal Eckmann
# Contributor(s): Stefan Haboeck, Nikolas Papaioannou

# Description:  Installs CSV and CVSS databases for EMBA

I30_version_vulnerability_check() {
  module_title "${FUNCNAME[0]}"

  if [[ "$LIST_DEP" -eq 1 ]] || [[ $IN_DOCKER -eq 1 ]] || [[ $DOCKER_SETUP -eq 0 ]] || [[ $FULL -eq 1 ]]; then
  
    NVD_URL="https://nvd.nist.gov/feeds/json/cve/1.1/"
    INSTALL_APP_LIST=()

    print_file_info "cve.mitre.org database" "CVEÂ® is a list of publicly known cybersecurity vulnerabilities." "https://cve.mitre.org/data/downloads/allitems.csv" "external/allitems.csv"
    for YEAR in $(seq 2002 $(($(date +%Y)))); do
      NVD_FILE="nvdcve-1.1-""$YEAR"".json"
      print_file_info "$NVD_FILE" "" "$NVD_URL""$NVD_FILE"".zip" "external/nvd/""$NVD_FILE"".zip" "./external/allitemscvss.csv"
    done
  
    if [[ "$LIST_DEP" -eq 1 ]] || [[ $DOCKER_SETUP -eq 1 ]] ; then
      ANSWER=("n")
    else
      echo -e "\\n""$MAGENTA""$BOLD""These databases will be downloaded and installed (if not already on the system)!""$NC"
      ANSWER=("y")
    fi
  
    case ${ANSWER:0:1} in
      y|Y )
        apt-get install "${INSTALL_APP_LIST[@]}" -y
        download_file "cve.mitre.org database" "https://cve.mitre.org/data/downloads/allitems.csv" "external/allitems.csv"
        if ! [[ -d "external/nvd" ]] ; then
          mkdir external/nvd
        fi
        for YEAR in $(seq 2002 $(($(date +%Y)))); do
          NVD_FILE="nvdcve-1.1-""$YEAR"".json"
          download_file "$NVD_FILE" "$NVD_URL""$NVD_FILE"".zip" "external/nvd/""$NVD_FILE"".zip"
  
          if [[ -f "external/nvd/""$NVD_FILE"".zip" ]] ; then
            unzip -o "./external/nvd/""$NVD_FILE"".zip" -d "./external/nvd"
            jq -r '. | .CVE_Items[] | [.cve.CVE_data_meta.ID, (.impact.baseMetricV2.cvssV2.baseScore|tostring), (.impact.baseMetricV3.cvssV3.baseScore|tostring)] | @csv' "./external/nvd/""$NVD_FILE" -c | sed -e 's/\"//g' >> "./external/allitemscvss.csv"
            rm "external/nvd/""$NVD_FILE"".zip"
            rm "external/nvd/""$NVD_FILE"
          else
            echo -e "$ORANGE""$NVD_FILE"" is not available or a valid zip archive""$NC"
          fi
        done
        rmdir "external/nvd/"
      ;;
    esac
  fi
}
