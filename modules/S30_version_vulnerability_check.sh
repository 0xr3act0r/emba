#!/bin/bash

# emba - EMBEDDED LINUX ANALYZER
#
# Copyright 2020 Siemens AG
#
# emba comes with ABSOLUTELY NO WARRANTY. This is free software, and you are
# welcome to redistribute it under the terms of the GNU General Public License.
# See LICENSE file for usage of this software.
#
# emba is licensed under GPLv3
#
# Author(s): Michael Messner, Pascal Eckmann

# Description:  Iterate trough all binaries and check if these occurs in the CVE database
#               Access:
#                 firmware root path via $FIRMWARE_PATH
#                 binary array via ${BINARIES[@]}


S30_version_vulnerability_check() {
  module_log_init "version_vulnerability_check"
  module_title "Version Vulnerability Check"

  if [[ "$(wc -l "$CONFIG_DIR""/version_strings.cfg" | cut -d\  -f1 2>/dev/null)" -gt 0 ]]; then
    if [[ $V_FEED -eq 1 ]]; then
      print_output "[*] Vulnerability database found!"
      echo

      for LINE in "${BINARIES[@]}"; do
        if (file "$LINE" | grep -q "ELF"); then
          local V_OUTPUT_G
          V_OUTPUT_G="$(config_grep "$CONFIG_DIR""/version_strings.cfg" "$LINE")"

          #filtering with manual blacklist ...
          readarray -t V_OUTPUT < <(echo "${V_OUTPUT_G[@]}" | grep -v '127.0.0.1' | grep -v '1.1.1.1' \
          | grep -v '0.0.0.' | grep -v '8.8.8.8' | grep -v '192.168.0' | grep -v '192.168.1' | grep -v '224.0.0.252' \
          | grep -v '255.255.255.' | sort -u )

          local VULNS
          readarray -t VULNS < <(grep -i "\\s""$(basename "$LINE")""\\s" "$VUL_FEED_DB" | sed "s/\"\"//g" | cut -d\| -f1 | cut -d, -f1,3- | sed "s/,/   /" | cut -d\" -f1,2 | sed "s/\"//" 2>/dev/null)

          # if we found less than 10 vulnerabilities, we print it here:
          if [[ ${#VULNS[@]} -gt 0 ]] && [[ ${#VULNS[0]} -gt 0 ]]; then
            print_output "[*] Found potential version details in ""$(print_path "$LINE")"
            print_output "[+] Found ""${#VULNS[@]}"" possible vulnerabilities for ""$(basename "$LINE")"" [all versions]:\\n"
            for LINE_ in "${VULNS[@]:0:10}"; do
              print_vul "$LINE_"
            done
            echo
          fi

          if [[ ${#VULNS[@]} -gt 0 ]] && [[ ${#V_OUTPUT[0]} -gt 0 ]] && [[ ${#V_OUTPUT[@]} -gt 0 ]]; then
            print_output "[*] Possible version details for ""$(basename "$LINE")"":"
            for V_VERSION in "${V_OUTPUT[@]}"; do
              print_output "$(indent "$(orange "$V_VERSION")")"
            done
            echo
          fi

          # if we found more than 10 vulnerabilities we try to use version details:
          if [[ ${#VULNS[@]} -gt 10 ]]; then
            for V_VERSION_2 in "${V_OUTPUT[@]}"; do
              # check database with binary name and version:
              if [ -n "$V_VERSION_2" ] ; then
                readarray -t VULNS < <(grep -i "\\s""$(basename "$LINE")""\\s" "$VUL_FEED_DB" | sed "s/\"\"//g" | cut -d\| -f1 | cut -d, -f1,3- | sed "s/,/   /" | cut -d\" -f1,2 | sed "s/\"//" | grep "$V_VERSION_2" 2>/dev/null)
                if [[ ${#VULNS[@]} -gt 0 ]]; then
                  print_output "[+] Found ""${#VULNS[@]}"" possible vulnerabilities for ""$(basename "$LINE")"" [""$V_VERSION_2""] (""$(print_path "$LINE")"")\\n"
                  for LINE_ in "${VULNS[@]:0:20}"; do
                    print_vul "$LINE_"
                  done
                  echo
                fi
              fi
            done
          fi
        fi
      done
    else
      print_output "[!] No vulnerability database found!"
    fi
  fi
}

print_vul() {
  WIDTH="$(($(tput cols) - 16))"
  readarray -t TEXT_ARR <<<"$1"
  for TEXT in "${TEXT_ARR[@]}"; do
    FIRST_LINE="$(echo "$TEXT" | cut -c 1-"$(($(tput cols) - 2))")"
    LAST_LINES="$(echo "$TEXT" | cut -c "$(($(tput cols) - 1))"-)"

    readarray -t L_LINES < <(echo "$LAST_LINES" | sed -r "s/(.{""$WIDTH""})/&\n/g")

    print_output "$(echo "$FIRST_LINE" | sed -r '/^\s*$/d')"
    for E_LINE in "${L_LINES[@]}"; do
      if [[ -n "$E_LINE" ]]; then
        print_output "                ""$( echo "$E_LINE" | sed -e 's/^[[:space:]]*//' -e 's/[[:space:]]*$//')"
      fi
    done

    if [[ -f "$VUL_FEED_CVSS_DB" ]]; then
      CVSS_VALUES="$(grep "$(echo "$FIRST_LINE" | cut -d' ' -f 1)" "$VUL_FEED_CVSS_DB")"
      CVSS2="$(echo "$CVSS_VALUES" | cut -f 2 -d ",")"
      CVSS3="$(echo "$CVSS_VALUES" | cut -f 3 -d ",")"
      CVSS_STRING=""
      if ! [[ "$CVSS2" == "null" ]]; then
        CVSS_STRING="$CVSS_STRING""CVSS2: ""$(color_cvss2 "$CVSS2")""   "
      fi
      if ! [[ "$CVSS3" == "null" ]]; then
        CVSS_STRING="$CVSS_STRING""CVSS3: ""$(color_cvss3 "$CVSS3")"
      fi
      print_output "                ""$CVSS_STRING"
    fi

    echo
  done
}

color_cvss2() {
  FIRST_NUM="$(echo "$1" | cut -f 1 -d ".")"
  if (( $((FIRST_NUM)) < 4 )) ; then
    echo "$GREEN""$1""$NC"
  elif (( 3 < $((FIRST_NUM)) )) && (( $((FIRST_NUM)) < 7 )) ; then
    echo "$ORANGE""$1""$NC"
  elif (( 6 < $((FIRST_NUM)) )) ; then
    echo "$MAGENTA""$1""$NC"
  fi
}

color_cvss3() {
  FIRST_NUM="$(echo "$1" | cut -f 1 -d ".")"
  if (( $((FIRST_NUM)) < 4 )) ; then
    echo "$GREEN""$1""$NC"
  elif (( 3 < $((FIRST_NUM)) )) && (( $((FIRST_NUM)) < 7 )) ; then
    echo "$ORANGE""$1""$NC"
  elif (( 6 < $((FIRST_NUM)) )) && (( $((FIRST_NUM)) < 9 )) ; then
    echo "$MAGENTA""$1""$NC"
  elif (( 8 < $((FIRST_NUM)) )) ; then
    echo "$RED""$1""$NC"
  fi
}
